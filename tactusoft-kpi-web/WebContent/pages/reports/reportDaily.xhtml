<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:c="http://java.sun.com/jsp/jstl/core"
	xmlns:ui="http://java.sun.com/jsf/facelets"
	xmlns:h="http://java.sun.com/jsf/html"
	xmlns:f="http://java.sun.com/jsf/core"
	xmlns:p="http://primefaces.org/ui"
	xmlns:pe="http://primefaces.org/ui/extensions">

<ui:composition template="../layout/main.xhtml">

	<ui:define name="title">
		#{msg['title_report_daymonth']}
	</ui:define>

	<ui:define name="content">

		<p:spacer height="10" />

		<h:form id="form">

			<p:panel width="100%">
				<h:panelGrid id="pnlParameter" columns="2" width="100%">
					<h:outputText value="#{msg['rep_calendar_week']}"
						style="width:100%" />
					<p:selectOneMenu value="#{reportBacking.idKpiWeek}"
						style="width:430px">
						<f:selectItems value="#{reportBacking.listItemWeeks}" />
					</p:selectOneMenu>
				</h:panelGrid>

				<f:facet name="footer">
					<p:commandButton id="cmdOK" update="recordTable panel"
						value="#{msg['btn_ok']}"
						actionListener="#{reportBacking.generateAction}">
					</p:commandButton>
				</f:facet>

			</p:panel>

			<p:spacer height="10" />

			<h:panelGrid id="display" width="100%">
				<p:dataTable id="recordTable" var="rec"
					value="#{reportBacking.model}">

					<p:column headerText="#{msg['rep_metric']}">
						<h:outputLabel value="#{rec.metric}" />
					</p:column>

					<p:column headerText="#{msg['rep_unit']}">
						<h:outputLabel value="#{rec.um}" />
					</p:column>

					<p:column headerText="">
						<h:outputLabel value="#{rec.type}" />
					</p:column>

					<p:columns value="#{reportBacking.columns}" var="column"
						columnIndexVar="colIndex">

						<f:facet name="header">#{column.header}</f:facet>

						<h:outputLabel value="#{rec.listPlan[colIndex]}"
							rendered="#{rec.um eq '%'?true:false}"
							styleClass="#{rec.style[colIndex]}">
							<f:convertNumber type="percent" />
						</h:outputLabel>

						<h:outputLabel value="#{rec.listPlan[colIndex]}"
							rendered="#{rec.um eq '%'?false:true}"
							styleClass="#{rec.style[colIndex]}">
							<f:convertNumber type="number" />
						</h:outputLabel>

					</p:columns>

				</p:dataTable>

				<p:spacer height="10" />

				<p:outputPanel style="display:block;width: 100%; height: 450px;"
					id="chart_div" />

			</h:panelGrid>

			<h:panelGrid id="panel">
				<script type="text/javascript">
					if(loaded)
					{
						var size = #{reportBacking.size};
						chartData = new google.visualization.DataTable();
						chartData.addRows(size);
						chartData.addColumn('string', "#{msg['rep_code']}");
						chartData.addColumn('number', "#{msg['rep_hr']}");
						chartData.addColumn('number', "#{msg['rep_avg']}");
						
						var rowIndex = 0;
						var list = jQuery.parseJSON('#{reportBacking.graphData}');
						$.each(list, function(id, row) {
							chartData.setValue(rowIndex,0,row.label);
							chartData.setValue(rowIndex,1,row.value);
							chartData.setValue(rowIndex,2,row.avg);
							rowIndex++;
						});

						var formatter = new google.visualization.NumberFormat(
							      {pattern:'#,###%'});
						formatter.format(chartData, 2); // Apply formatter to second column

						chart.draw(chartData, chartOptions);
					}
					</script>
			</h:panelGrid>

			<pe:remoteCommand name="drillDown"
				action="#{reportBacking.drillDownAction}" update="dialogView"
				oncomplete="dlgView.show()">
				<pe:remoteCommandParameter name="p_row"
					applyTo="#{reportBacking.rowReport}" />
				<pe:remoteCommandParameter name="p_column"
					applyTo="#{reportBacking.columnReport}" />
			</pe:remoteCommand>

			<p:dialog header="#{reportBacking.delayName}" widgetVar="dlgView"
				resizable="false" id="dialogView" showEffect="fade"
				hideEffect="explode" modal="true">

				<p:dataTable id="recordTableHours" var="rec"
					value="#{reportBacking.modelHours}" rowKey="#{rec.id}"
					paginator="true" rows="10">

					<p:column headerText="#{msg['day_wo_OT']}">#{rec.wo}</p:column>

					<p:column headerText="#{msg['day_wo_num_hours']}">
						<h:outputText value="#{rec.numHours}">
							<f:convertNumber pattern="###.##" />
						</h:outputText>
					</p:column>

				</p:dataTable>

				<f:facet name="footer">
					<p:commandButton id="cmdReturnDetail" onclick="dlgView.hide()"
						process="@none" icon="ui-icon-arrowreturnthick-1-w"
						value="#{msg['btn_return']}" />
				</f:facet>

			</p:dialog>

		</h:form>

		<script type="text/javascript">
			loaded=false;
			google.setOnLoadCallback(drawChart);

			// Callback that creates and populates a data table, 
			// instantiates the pie chart, passes in the data and
			// draws it.

			function drawChart() {
				loaded=true;
				
				// Create our data table.
				chartData = new google.visualization.DataTable();
				
				chartData.addColumn('string', "#{msg['rep_code']}");
				chartData.addColumn('number', "#{msg['rep_hr']}");
				chartData.addColumn('number', "#{msg['rep_avg']}");

				chartOptions = {
	                    title : "#{msg['rep_delay_last_day']}",
	                    vAxis: {title: "#{msg['rep_hr']}", titleTextStyle:{fontName:'Arial', fontSize:15}, textPosition: 'out'},
	                    seriesType: "bars",
	                    series:{1:{type: 'line',targetAxisIndex:1, visibleInLegend :false}}, vAxes:{1:{minValue: 0, title:"#{msg['rep_avg']}",textStyle:{color: 'red'}, format:'#,###%'}}
	                  };
	 
	            chart = new google.visualization.ComboChart(document.getElementById('form:chart_div'));
	
				//first arg to draw is an instance of chartData, the second are options 
				chart.draw(chartData, chartOptions);

				google.visualization.events.addListener(chart, 'select', 
					function() {
						var sel = chart.getSelection()[0]; 
						var row = sel.row;
						var column = sel.column;
						drillDown(row,column);
					});
			}
		</script>

	</ui:define>
</ui:composition>

</html>